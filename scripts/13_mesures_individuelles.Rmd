---
title: "ASPE - Traitements sur les mesures individuelles"
author: "Pascal Irz"
date: "`r format(Sys.time(), 'Le %d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Objectif

Ce tutoriel est un guide pour obtenir, à partir de la base Aspe, les résultats suivants :

- distributions en taille et en masse
- densité surfacique et volumique en biomasse

Il est donc ici nécessaire de faire appel aux mesures réalisées sur chaque individu (masse, longueur). La table contenant ces données est la plus volumineuse de la base donc les traitements peuvent être chronophages à l'échelle de la France entière. Ici, nous allons à titre d'exemple restreindre l'analyse à un département : le Morbihan (56) et ne conserver que les pêches dites "complètes".

Le chargement du package `{aspe}` est supposé déjà réalisé (si besoin voir [ce support](https://rpubs.com/kamoke/713407)).

Les fonctions dédiées au traitement des mesures individuelles sont nommées avec le préfiwe `'mei_'`. Celles dédiées à la mise en forme des données par `'mef_'`.

# Chargement des packages et des données

```{r, eval = FALSE}
library(aspe)
library(tidyverse)

load(file = "raw_data/tables_sauf_mei_2021_10_21_11_44_01.RData")
load(file = "raw_data/mei_2021_10_21_11_44_01.RData")
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
library(aspe)
library(tidyverse)

rdata_tables <- misc_nom_dernier_fichier(repertoire = "../../../raw_data",
                                         pattern = "^tables")

rdata_mei <- misc_nom_dernier_fichier(repertoire = "../../../raw_data",
                                      pattern = "^mei")

load(rdata_tables)
load(rdata_mei)

rm(rdata_tables, rdata_mei)
```




Vérification de la présence des tables dans l'environnement.

```{r}
map(.x = ls(),
    .f = function(x) {
      nom <- x
      lignes <- x %>% get() %>% nrow()
      colonnes <- x %>% get() %>% ncol()
      data.frame(nom, lignes, colonnes)
    }) %>% 
  reduce(rbind) %>% 
  DT::datatable()
```

# Assemblage d'une "passerelle"

Les données dont il y a besoin sont dispersées dans diverses tables. C'est le tableau "passerelle" qui sert à les relier.

```{r}
passerelle <- mef_creer_passerelle()
```

## Filtrage sur le département 56

```{r}
id_stations_56 <- passerelle %>%
  mef_ajouter_dept() %>% # création du champ dept à partir du code Insee station (ou point si manquant)
  filter(dept == '56') %>% # sélection des observations sur les numéros de dept
  pull(sta_id) # extraction des identifiants des stations

data <- passerelle %>% 
  filter(sta_id %in% id_stations_56)
```

## Filtrage sur la méthode de prospection

Dans la table `ref_protocole` on peut voir que les pêches complètes correspondent à la variable `pro_id` égale à `1`. Pour filtrer plus rapidement que montré dans les exemple ci-dessus, on peut filtrer sur cette méthode.

```{r}
data <- data %>%
  mef_ajouter_type_protocole() %>% 
  filter(pro_libelle == "Pêche complète à un ou plusieurs passages") %>% 
  select(-pro_id)
```

# Incorporation des mesures individuelles

Il s'agit de compléter le jeu de données, qui ne contient à ce stade que des identifiants, par les informations qui seront utiles pour l'interprétation. Par exemple il est plus facile de lier les résultats avec les codes espèces à trois lettres ou les noms des stations qu'avec les identifiants.

```{r}
data_ind <- data %>%
  mef_ajouter_libelle() %>% 
  mef_ajouter_ope_date() %>% 
  mef_ajouter_passage() %>% # numéro du passage pour éventuellement filtrer dessus
  mef_ajouter_lots() %>% 
  mef_ajouter_esp_code_alternatif() %>% 
  mef_ajouter_mei() %>% 
  mef_ajouter_type_longueur() %>% 
  select(-obj_id,
         -mei_id,
         -tlo_id) # suppression colonnes inutiles
```

Blabla exliquer la signification des champs.

## Histogramme des longueurs pour une espèce à l'occasion d'une opération.

La fonction `gg_histo_longueur()` sert à produire l'histogramme des longueurs mesurées (ou estimées à partir des poids) des individus. Elle prend en entrée :

- le `dataframe` issu des étapes précédentes
- le numéro d'opération
- l'espèce (ou les espèces si l'on veut les regrouper, par exemple sous la forme `especes = c("CAS", "CAX", "CAG")`)
- Le type de longueur, à choisir parmi `Fourche`, `Totale` ou `Estimée d'après le poids` avec la possibilité d'indiquer plusieurs types sous la forme `type_longueur = c("Fourche", "Estimée d'après le poids")`. 
- Le nombre d'intervalles de longueur sur le graphique, qui est de 30 par défaut.

```{r}
gg_histo_longueur(indiv_df = data_ind,
                  operation = 6313,
                  especes = "GOU",
                  type_longueur = "Fourche",
                  n_intervalles = 25)
```




