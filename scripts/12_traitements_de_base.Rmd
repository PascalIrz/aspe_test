---
title: "Traitements de base à partir des lots"
author: "Pascal Irz"
date: "`r format(Sys.time(), 'Le %d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
```

# Objectif

Le présent document est un guide pour obtenir, à partir de la base Aspe, les résultats de pêche sous différentes formes :

- richesse en espèces
- occurrence des espèces
- abondances des espèces
- densités des espèces

Les analyses faisant appel aux mesures réalisées sur chaque individu (taille, longueur, pathologies ...) ne sont pas abordées ici. 

Les étapes de chargement et d'activation du packages sont supposées déjà réalisées (voir autres supports).

# Chargement des packages et des données

```{r, eval = FALSE}
library(aspe)
library(tidyverse)

load(file = "processed_data/toutes_tables_aspe_sauf_mei.RData")
```

```{r, eval = TRUE, echo = FALSE}
library(aspe)
library(tidyverse)

load(file = "../processed_data/toutes_tables_aspe_sauf_mei.RData")
```

# Assemblage des données

Les données dont il y a besoin sont dispersées dans diverses tables. C'est la tableau "passerelle" qui sert à les relier.

```{r}
passerelle <- creer_passerelle()
```

- Données de captures $\Rightarrow$ table `lot_poissons`
- Données de superficie échantillonnée, méthode de pêche, etc. $\Rightarrow$ table `operation`
- Numéro de passage (pour éventuellement n'en conserver qu'un) $\Rightarrow$ table `prelevement_elementaire`
- Caractéristiques de la station $\Rightarrow$ table `station`

Pour ce qui est des traitements classiques (pour moi) : effectifs par espèces et par opérations avec comme champs de base (pas sûr que ça colle exactement à la dénomination de la base actuelle) :

st_id; st_nom; st_long;
ope_id; ope_date; ope_methode; ope_moyen; ope_surf; ope_nb point; ope_nb zone; ope_long; ope_larg; ope_prof;
numero_passage;
code_esp; effectif; biomasse

On effectue donc une série de jointures "gauches" pour compléter la passerelle de ces données.

# Filtrage du jeu de données

Il peut être utile de filtrer les données en amont des calculs pour éviter de mélanger des choses peu comparables.

Outre le filtrage régional, dans l'exemple ci-dessous, on ne va retenir que les premiers passages des pêches complètes, réalisées à pied.

## Filtrage régional

```{r}

depts_bzh <- c(22, 29, 35, 56)

id_stations_bzh <- station %>%
  mutate(sta_dept = str_sub(sta_com_code_insee, start = 1, end = 2)) %>%
  filter(sta_dept %in% depts_bzh) %>%
  pull(sta_id)

data <- passerelle %>% 
  filter(sta_id %in% id_stations_bzh)
```

## Filtrage sur le moyen de pêche

Récupération des champs nécessaires dans les tables `operation_description_peche` et `ref_moyen_prospection` :

```{r}
data <- data %>% 
  left_join(y = operation_description_peche %>% select(ope_id = odp_ope_id, mop_id = odp_mop_id)) %>% 
  left_join(y = ref_moyen_prospection %>% select(mop_id, mop_libelle))

names(data)
```

Filtrage :

```{r}
data <- data %>% 
  filter(mop_libelle == 'A pied')
```

On peut ensuite supprimer les colonnes qui ne servent plus

```{r}
data <- data %>% 
  select(-mop_id, -mop_libelle)
```

## Filtrage sur la méthode de prospection

Dans la table `ref_protocole` on peut voir que les pêches complètes correspondent à la variable `pro_id` égale à `1`. Pour filtrer plus rapidement que montré dans les exemple ci-dessus, on peut filtrer sur cette méthode.

```{r}
data <- data %>% 
  left_join(y = operation %>% select(ope_id, pro_id = ope_pro_id)) %>% 
  filter(pro_id == 1)
```

